name: Build & Publish Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release-Version (z.B. 1.5.0)"
        required: true
  push:
    tags:
      - "v*"

jobs:
  build-release:
    if: ${{ false }} # deaktiviert in diesem Repo; nutze das Updates-Repo
    runs-on: windows-latest

    env:
      VERSION: ${{ github.event.inputs.version || github.ref_name }}
      INSTALLER_NAME: INAT-Solutions-Setup.exe

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps (optional)
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            Write-Host "requirements.txt nicht gefunden – Schritt übersprungen"
          }
          pip install pyinstaller
        shell: pwsh

      - name: Install Inno Setup
        run: choco install innosetup --no-progress
        shell: pwsh

      - name: Build Application (PyInstaller)
        run: |
          pyinstaller -y main.spec
        shell: pwsh

      - name: Build Installer
        run: |
          iscc installer/INAT-Solutions.iss
        shell: pwsh

      - name: Compute SHA256
        id: hash
        run: |
          $hash = (Get-FileHash "dist/${{ env.INSTALLER_NAME }}" -Algorithm SHA256).Hash.ToLower()
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Write manifest
        run: |
          $manifest = @{
            version    = "${{ env.VERSION }}"
            installer  = @{
              filename = "${{ env.INSTALLER_NAME }}"
              url      = "https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/${{ env.INSTALLER_NAME }}"
              sha256   = "${{ steps.hash.outputs.sha256 }}"
            }
            notes_url      = "https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}"
            release_notes  = "Automatisch erzeugtes Release für Version ${{ env.VERSION }}"
          } | ConvertTo-Json -Depth 4
          $manifest | Set-Content -Encoding utf8 update_manifest.json
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          draft: false
          prerelease: false
          files: |
            dist/${{ env.INSTALLER_NAME }}
            update_manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish manifest to Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          destination_dir: .
          keep_files: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          enable_jekyll: false
